# Enhanced Coverage Workflow Section for ci-enhanced.yml
# This section replaces the existing unit-tests job

  unit-tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 50

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install Ceedling and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc lcov python3-pip
        pip3 install gcovr lxml
        gem install ceedling

    - name: Run unit tests and generate coverage
      run: |
        set -e

        # Initialize counters
        TOTAL_TESTS=0
        PASSED_TESTS=0
        FAILED_TESTS=0
        TEST_DIRS_COUNT=0

        # Coverage tracking
        declare -A COVERAGE_DATA
        OVERALL_LINE_COV=0
        OVERALL_BRANCH_COV=0
        OVERALL_FUNC_COV=0

        # Create detailed test results file
        echo "=== Unit Test Results ===" > test_results.txt
        echo "Run started at: $(date)" >> test_results.txt
        echo "" >> test_results.txt

        # Find all test directories containing project.yml files
        test_dirs=$(find tests -name "project.yml" -type f -exec dirname {} \;)

        if [ -z "$test_dirs" ]; then
          echo "No test directories found with project.yml files"
          exit 1
        fi

        for test_dir in $test_dirs; do
          echo "=== Running tests in: $test_dir ===" >> test_results.txt
          echo "Running tests in: $test_dir"
          cd "$test_dir"

          # Run tests with coverage
          if ceedling gcov:all > test_output.txt 2>&1; then
            echo "âœ… Test suite completed successfully" >> ../../../test_results.txt
          else
            echo "âŒ Test suite encountered errors" >> ../../../test_results.txt
          fi

          # Parse test results from Ceedling output
          DIR_TESTS=$(grep "^TESTED:" test_output.txt 2>/dev/null | tail -1 | grep -o '[0-9]\+' || echo "0")
          DIR_PASSED=$(grep "^PASSED:" test_output.txt 2>/dev/null | tail -1 | grep -o '[0-9]\+' || echo "0")
          DIR_FAILED=$(grep "^FAILED:" test_output.txt 2>/dev/null | tail -1 | grep -o '[0-9]\+' || echo "0")

          # Parse coverage data from console output
          # Extract line coverage percentages
          LINE_COV=$(grep -E "Lines executed:[0-9.]+%" test_output.txt | sed 's/.*Lines executed:\([0-9.]\+\)%.*/\1/' | head -1 || echo "0")
          BRANCH_COV=$(grep -E "Branches executed:[0-9.]+%" test_output.txt | sed 's/.*Branches executed:\([0-9.]\+\)%.*/\1/' | head -1 || echo "0")

          # Parse HTML coverage report if available
          if [ -f "build/artifacts/gcov/gcovr/GcovCoverageResults.html" ]; then
            # Extract overall coverage from HTML
            HTML_LINE_COV=$(grep -o 'class="coverage-[^"]*">[0-9.]\+%' build/artifacts/gcov/gcovr/GcovCoverageResults.html | grep -o '[0-9.]\+' | head -1 || echo "0")
            if [ -n "$HTML_LINE_COV" ] && [ "$HTML_LINE_COV" != "0" ]; then
              LINE_COV=$HTML_LINE_COV
            fi
          fi

          # Store coverage data
          COVERAGE_DATA["$test_dir"]="$LINE_COV"

          # Validate the numbers
          DIR_TESTS=${DIR_TESTS:-0}
          DIR_PASSED=${DIR_PASSED:-0}
          DIR_FAILED=${DIR_FAILED:-0}
          LINE_COV=${LINE_COV:-0}

          # Capture failed test names
          if [ "$DIR_FAILED" -gt 0 ]; then
            echo "âŒ Failed tests in $test_dir:" >> ../../../test_results.txt
            grep -A 5 -B 2 "FAIL\|ERROR" test_output.txt | head -20 >> ../../../test_results.txt 2>/dev/null || \
              echo "  (Failed test details not available)" >> ../../../test_results.txt
            echo "" >> ../../../test_results.txt
          else
            echo "âœ… All tests passed in $test_dir" >> ../../../test_results.txt
          fi

          # Add coverage info to results
          echo "ğŸ“Š Coverage: ${LINE_COV}% lines" >> ../../../test_results.txt
          echo "Total tests in $test_dir: $DIR_TESTS (Passed: $DIR_PASSED, Failed: $DIR_FAILED)" >> ../../../test_results.txt
          echo "" >> ../../../test_results.txt

          TOTAL_TESTS=$((TOTAL_TESTS + DIR_TESTS))
          PASSED_TESTS=$((PASSED_TESTS + DIR_PASSED))
          FAILED_TESTS=$((FAILED_TESTS + DIR_FAILED))
          TEST_DIRS_COUNT=$((TEST_DIRS_COUNT + 1))

          # Accumulate coverage (simple average for now)
          OVERALL_LINE_COV=$(echo "$OVERALL_LINE_COV + $LINE_COV" | bc -l 2>/dev/null || echo "$OVERALL_LINE_COV")

          cd - > /dev/null
        done

        # Calculate average coverage
        if [ "$TEST_DIRS_COUNT" -gt 0 ]; then
          OVERALL_LINE_COV=$(echo "scale=1; $OVERALL_LINE_COV / $TEST_DIRS_COUNT" | bc -l 2>/dev/null || echo "0")
        fi

        # Add summary to results
        echo "=== Test Summary ===" >> test_results.txt
        echo "Total test suites: $TEST_DIRS_COUNT" >> test_results.txt
        echo "Total tests: $TOTAL_TESTS" >> test_results.txt
        echo "Passed: $PASSED_TESTS" >> test_results.txt
        echo "Failed: $FAILED_TESTS" >> test_results.txt
        echo "Overall Line Coverage: ${OVERALL_LINE_COV}%" >> test_results.txt

        # Calculate test success rate
        if [ $TOTAL_TESTS -gt 0 ]; then
          TEST_SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
        else
          TEST_SUCCESS_RATE=0
        fi

        # Set environment variables for GitHub Actions
        echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_ENV
        echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_ENV
        echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
        echo "TEST_SUCCESS_RATE=$TEST_SUCCESS_RATE" >> $GITHUB_ENV
        echo "TEST_DIRS_COUNT=$TEST_DIRS_COUNT" >> $GITHUB_ENV
        echo "OVERALL_LINE_COV=$OVERALL_LINE_COV" >> $GITHUB_ENV

    - name: Create Enhanced Job Summary
      if: always()
      run: |
        # Determine coverage status emoji and color
        COV_EMOJI="ğŸ”´"
        COV_STATUS="Low"
        if (( $(echo "${{ env.OVERALL_LINE_COV }} >= 90" | bc -l) )); then
          COV_EMOJI="ğŸŸ¢"
          COV_STATUS="High"
        elif (( $(echo "${{ env.OVERALL_LINE_COV }} >= 75" | bc -l) )); then
          COV_EMOJI="ğŸŸ¡"
          COV_STATUS="Medium"
        fi

        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ğŸ§ª Unit Tests & Coverage Dashboard

        ### ğŸ“Š Test Metrics
        | Metric | Value | Status |
        |--------|-------|--------|
        | ğŸ¯ Test Suites | ${{ env.TEST_DIRS_COUNT }} | âœ… |
        | âœ… Total Tests | ${{ env.TOTAL_TESTS }} | âœ… |
        | ğŸŸ¢ Passed | ${{ env.PASSED_TESTS }} | âœ… |
        | ğŸ”´ Failed | ${{ env.FAILED_TESTS }} | ${{ env.FAILED_TESTS == '0' && 'âœ…' || 'âŒ' }} |
        | ğŸ“ˆ Success Rate | ${{ env.TEST_SUCCESS_RATE }}% | ${{ env.TEST_SUCCESS_RATE >= 95 && 'âœ…' || env.TEST_SUCCESS_RATE >= 90 && 'ğŸŸ¡' || 'âŒ' }} |

        ### ğŸ¯ Coverage Metrics
        | Type | Coverage | Status |
        |------|----------|--------|
        | ğŸ“Š Line Coverage | ${{ env.OVERALL_LINE_COV }}% | ${COV_EMOJI} ${COV_STATUS} |

        ### Overall Status: ${{ env.FAILED_TESTS == '0' && 'âœ… All Tests Passed' || 'âŒ Test Failures Detected' }}

        ${{ env.TEST_SUCCESS_RATE < 90 && 'âš ï¸ **Test success rate below 90%. Consider improving test reliability.**' || '' }}
        ${{ env.TOTAL_TESTS == '0' && 'âš ï¸ **No tests found. Consider adding unit tests.**' || '' }}

        EOF

        # Add coverage recommendations
        if (( $(echo "${{ env.OVERALL_LINE_COV }} < 75" | bc -l) )); then
          echo "âš ï¸ **Line coverage is below 75%. Consider adding more comprehensive tests.**" >> $GITHUB_STEP_SUMMARY
        fi

        # Add detailed test results if there are failures
        if [ "${{ env.FAILED_TESTS }}" != "0" ] && [ -f "test_results.txt" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Detailed Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 20 "Failed tests" test_results.txt | head -50 >> $GITHUB_STEP_SUMMARY 2>/dev/null || \
            echo "Test failure details not available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ğŸ“ **Full test results are available in the uploaded artifacts**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate Coverage Badge Data
      if: always()
      run: |
        # Create badge data for potential use
        COV_COLOR="red"
        if (( $(echo "${{ env.OVERALL_LINE_COV }} >= 90" | bc -l) )); then
          COV_COLOR="brightgreen"
        elif (( $(echo "${{ env.OVERALL_LINE_COV }} >= 75" | bc -l) )); then
          COV_COLOR="yellow"
        fi

        # Create a simple JSON with coverage data
        cat > coverage-badge.json << EOF
        {
          "schemaVersion": 1,
          "label": "coverage",
          "message": "${{ env.OVERALL_LINE_COV }}%",
          "color": "$COV_COLOR"
        }
        EOF

        echo "Coverage badge data generated"

    - name: Check Coverage Threshold
      if: always()
      run: |
        THRESHOLD=70
        if (( $(echo "${{ env.OVERALL_LINE_COV }} < $THRESHOLD" | bc -l) )); then
          echo "âŒ Coverage ${{ env.OVERALL_LINE_COV }}% is below threshold of ${THRESHOLD}%"
          echo "Consider adding more tests to improve coverage"
          # Uncomment the next line to fail the build on low coverage
          # exit 1
        else
          echo "âœ… Coverage ${{ env.OVERALL_LINE_COV }}% meets the threshold of ${THRESHOLD}%"
        fi

    - name: Upload test results and coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: |
          tests/**/build/artifacts/test/
          tests/**/build/artifacts/gcov/
          tests/**/test_output.txt
          test_results.txt
          coverage-badge.json
        retention-days: 30
